name: Host Open-WebUI

on:
  schedule:
    - cron: '0 * * * *'  # Run every hour
  workflow_dispatch:  # Allow manual triggers

jobs:
  host-open-webui:
    runs-on: ubuntu-latest
    steps:
      - name: Install ngrok
        run: |
          curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
          tar xvzf ngrok.tgz
          chmod +x ngrok

      - name: Set up ngrok auth
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: ./ngrok authtoken $NGROK_AUTH_TOKEN

      - name: Cache Docker container state
        id: cache-container
        uses: actions/cache@v3
        with:
          path: |
            ~/container-save
            ~/volume-data
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Load cached container and volumes
        if: steps.cache-container.outputs.cache-hit == 'true'
        run: |
          # Restore volume data
          sudo mkdir -p /var/lib/docker/volumes/ollama/_data
          sudo mkdir -p /var/lib/docker/volumes/open-webui/_data
          sudo cp -r ~/volume-data/ollama/* /var/lib/docker/volumes/ollama/_data/ || true
          sudo cp -r ~/volume-data/open-webui/* /var/lib/docker/volumes/open-webui/_data/ || true
          
          # Load the container if it exists
          if [ -f ~/container-save/open-webui.tar ]; then
            docker load < ~/container-save/open-webui.tar
          fi

      - name: Run Open-WebUI
        run: |
          # Pull and run the container
          docker pull ghcr.io/open-webui/open-webui:ollama
          docker run -d -p 3000:8080 -v ollama:/root/.ollama -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:ollama
          
          # Wait for container to be ready
          echo "Waiting for container to be ready..."
          sleep 15

      - name: Start ngrok tunnel and get URL
        run: |
          # Start ngrok in the background with the skip browser warning header
          ./ngrok http 3000 --log=stdout --request-header-add "ngrok-skip-browser-warning: true" > ngrok.log 2>&1 &
          
          # Wait for ngrok to start and create the API
          sleep 5
          
          # Debug: Check if ngrok is running
          ps aux | grep ngrok
          
          # Debug: Check ngrok logs
          cat ngrok.log
          
          # Try multiple times to get the URL in case of slow startup
          for i in {1..10}; do
            echo "Attempt $i to get ngrok URL..."
            if NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'); then
              if [ ! -z "$NGROK_URL" ] && [ "$NGROK_URL" != "null" ]; then
                echo "Successfully got ngrok URL"
                break
              fi
            fi
            echo "Failed to get URL, waiting 5 seconds..."
            sleep 5
          done
          
          # Debug: Show final URL value
          echo "Final NGROK_URL value: $NGROK_URL"
          
          # Store URL in environment file for GitHub Actions
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          
          # Set output for the step
          echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
          
          # Print URL with clear formatting
          echo "::notice ::Open-WebUI is accessible at: $NGROK_URL"
          echo "============================================="
          echo "🌐 Access URL: $NGROK_URL"
          echo "============================================="

      - name: Keep alive
        run: |
          # Keep the workflow running for ~50 minutes (allowing time for cleanup and saves)
          echo "Initial URL check: ${{ env.NGROK_URL }}"
          for i in {1..10}; do
            echo "Time elapsed: $((i*5)) minutes"
            echo "Current access URL: ${{ env.NGROK_URL }}"
            curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' || echo "Failed to get current URL"
            sleep 300
          done

      - name: Save container and volume state
        if: always()
        run: |
          # Create save directories
          mkdir -p ~/container-save ~/volume-data/ollama ~/volume-data/open-webui
          
          # Save the container
          docker commit open-webui open-webui:latest
          docker save open-webui:latest > ~/container-save/open-webui.tar
          
          # Save volume data
          sudo cp -r /var/lib/docker/volumes/ollama/_data/* ~/volume-data/ollama/ || true
          sudo cp -r /var/lib/docker/volumes/open-webui/_data/* ~/volume-data/open-webui/ || true
          
          # Ensure correct permissions for cache
          sudo chown -R $(id -u):$(id -g) ~/container-save ~/volume-data